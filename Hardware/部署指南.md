# 🚀 完整部署指南

## 📋 系统组成

智能盆栽系统由三部分组成：

1. **ESP32硬件端** - 麦克风、扬声器、OLED、摄像头
2. **服务器端** - 语音识别、动作识别、对话处理
3. **Web监控端** - 网页监控界面

## 🔧 部署步骤

### 第一步：准备硬件

#### 所需硬件清单
- ESP32开发板 x1
- SPH0645麦克风模块 x1
- MAX98357A功放模块 x1
- SSD1306 OLED显示屏 x1
- ESP32-CAM摄像头模块 x1（可选）
- 扬声器（3W-5W） x1
- 杜邦线若干
- 面包板 x1

#### 硬件连接
按照 `Hardware/README.md` 中的引脚图连接所有硬件

### 第二步：配置服务器

#### 1. 安装conda环境
```bash
conda create -n SmartPlanter python=3.11 -y
conda activate SmartPlanter
```

#### 2. 安装依赖
```bash
pip install -r Hardware/requirements.txt
```

#### 3. 获取电脑IP地址
```bash
# macOS/Linux
ifconfig | grep "inet "

# Windows
ipconfig

# 找到类似 10.207.99.24 的地址
```

#### 4. 修改配置
编辑 `Hardware/config.py`:
```python
SERVER_BASE_URL = "http://10.207.99.24:8000"  # 改为你的IP
WIFI_SSID = "Columbia University"
WIFI_PASSWORD = ""
```

### 第三步：烧录ESP32

#### 1. 安装MicroPython固件
```bash
# 安装esptool
pip install esptool

# 擦除flash
esptool.py --chip esp32 --port /dev/ttyUSB0 erase_flash

# 烧录固件
esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash -z 0x1000 esp32-*.bin
```

#### 2. 上传Python代码
```bash
# 安装mpremote
pip install mpremote

# 使用上传脚本
cd Hardware
./upload_to_esp32.sh

# 或手动上传
mpremote connect /dev/ttyUSB0 fs cp config.py :
mpremote connect /dev/ttyUSB0 fs cp main.py :
# ... 上传所有文件
```

#### 3. 上传依赖库
```bash
# 上传ssd1306（OLED库）
mpremote connect /dev/ttyUSB0 fs cp ssd1306.py :
```

### 第四步：启动系统

#### 1. 启动服务器
```bash
# 在终端1
conda activate SmartPlanter
python Hardware/server.py
```

应该看到：
```
Smart Plant Server Starting...
Listening on: http://0.0.0.0:8000
```

#### 2. 启动Web监控（可选）
```bash
# 在终端2
conda activate SmartPlanter
python Web/app.py
```

访问: http://localhost:8080

#### 3. 启动ESP32
```bash
# 在终端3
mpremote connect /dev/ttyUSB0 run main.py
```

或直接重启ESP32让它自动运行

## ✅ 验证系统

### 1. 检查WiFi连接
串口输出应该显示：
```
WiFi connected: ('10.207.99.xx', ...)
```

### 2. 检查硬件初始化
```
Mic I2S init OK
Speaker I2S init OK
OLED initialized
Camera initialized
Smart Plant initialized!
```

### 3. 测试对话功能

**方式1: 通过网页**
1. 打开 http://localhost:8080
2. 点击"开启对话"按钮
3. 对着ESP32麦克风说话
4. 观察OLED显示和串口输出

**方式2: 通过语音**
1. 对着麦克风说 "hello world"
2. 系统应该回复 "Hello! I'm your smart plant..."
3. 继续对话
4. 说 "bye bye" 结束

### 4. 测试动作识别
1. 在摄像头前做动作（挥手、举手等）
2. 观察串口输出 "Gesture detected: ..."
3. 在Web页面查看动作记录

## 🔍 故障排查

### WiFi连接失败
```bash
# 检查信号
# 检查SSID和密码
# 尝试用手机热点测试
```

### 服务器连接失败
```bash
# 1. 检查防火墙
sudo ufw allow 8000

# 2. 检查IP地址
ifconfig

# 3. 测试连接
curl http://10.207.99.24:8000
```

### 麦克风无声
```bash
# 检查I2S引脚连接
# 检查VDD是否是3.3V
# 增加录音时长测试
```

### OLED无显示
```bash
# 检查I2C地址
mpremote connect /dev/ttyUSB0 repl
>>> from machine import I2C, Pin
>>> i2c = I2C(0, scl=Pin(22), sda=Pin(21))
>>> i2c.scan()  # 应该返回 [60] 或 [3C]
```

## 📊 完整工作流程图

```
用户 → 说话
    ↓
ESP32麦克风 → 录音3秒
    ↓
通过WiFi → 服务器(8000端口)
    ↓
server.py:
  ├─ 语音识别（Google STT）
  ├─ 对话处理（生成回复）
  └─ 数据记录（→ Web系统8080端口）
    ↓
返回回复 → ESP32
    ↓
ESP32 OLED显示 + 扬声器播放（待实现）
```

```
摄像头 → 拍照
    ↓
通过WiFi → 服务器(8000端口)
    ↓
server.py:
  ├─ 动作识别（MediaPipe）
  ├─ 判断动作类型
  └─ 记录到Web系统
    ↓
返回动作 → ESP32
    ↓
OLED显示动作名称
```

## 🌐 网络架构

```
Columbia University WiFi
├── ESP32 (10.207.99.xx)
│   └─> 发送音频/图片到服务器
│
├── 服务器 (10.207.99.24:8000)
│   ├─> 处理ESP32请求
│   └─> 同步数据到Web
│
└── Web监控 (10.207.99.24:8080)
    └─> 显示监控界面
```

## 📱 使用场景

### 场景1: 日常对话
1. 说 "hello world" 开启对话
2. 问 "how are you?"
3. 说 "tell me a joke"
4. 说 "bye bye" 结束

### 场景2: 远程监控
1. 打开手机浏览器
2. 访问公网链接（如果用了ngrok）
3. 查看实时数据
4. 点击按钮控制对话

### 场景3: 动作控制
1. 在摄像头前挥手 → 记录到日志
2. 双手举高 → 触发特定回复
3. 在Web页面查看所有动作

## 🔐 安全建议

1. **WiFi安全**: 使用学校WiFi时注意权限
2. **服务器安全**: 不要暴露到公网（除非加密）
3. **数据隐私**: 语音和图片仅本地处理
4. **Web访问**: 添加密码保护（生产环境）

## 📈 性能参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 录音时长 | 3秒 | 可调整1-10秒 |
| 采样率 | 16kHz | 语音识别标准 |
| 图片分辨率 | QVGA (320x240) | 可提高到VGA |
| 检查间隔 | 2秒 | 状态检查频率 |
| 对话延迟 | ~2-3秒 | 取决于网络 |

## 🎯 下一步优化

- [ ] 添加TTS（文字转语音）
- [ ] 优化对话延迟
- [ ] 添加更多动作识别
- [ ] 支持离线模式
- [ ] 添加电池供电
- [ ] 优化功耗

---

**部署完成！开始使用你的智能盆栽吧！🌱**
